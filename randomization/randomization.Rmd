---
title: "OOPA Risk of Material Breach Randomization"
author: "Nathaniel Olin"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
---

This script randomly assigns all BRTs in the City of Philadelphia to receive either old letters or new letters (50-50 split), and exports

* A timestamped file of the randomization for backup purposes, and
* A skinny `rando.csv` file with BRT and treatment assignment.

```{r, include = F}
options(cli.width = 100)
```

```{r}
library(tidyverse)
```


```{r}
dat <- read_csv(file.path('..', 'data', 'basefile.csv'))
dat$property_zip5 <- as.character(dat$property_zip5)
```

# Set up randomization

## Configure parameters

```{r}
# Probability of assignment to treatment
prob <- 0.5
# Condition names
conditions <- c('Control', 'New Letter')
# Blocking variables
block_var <- c('status', 'tier', 'property_zip5', 'different_mail')
```

## Check distribution of block variables

```{r}
qplot(dat$property_zip5) + coord_flip()

for(i in c(1, 2, 4)){
  p <- dat %>%
    filter(!is.na(case)) %>%
    ggplot(aes_string(block_var[i])) + geom_bar()
  print(p)
}
```


## Create blocks

```{r}
dat$block <- do.call(paste, c(dat[, block_var], sep = '|'))
```

# Randomize

```{r}
dat$treat <- randomizr::block_ra(blocks = dat$block, 
                                 prob = prob,
                                 conditions = conditions)
```

## Checks

Proportion of sample in small strata

```{r}
dat %>%
  group_by(block) %>%
  summarize(block_size = n()) %>%
  ungroup() %>%
  group_by(block_size) %>%
  summarize(
    n_strata = n(),
    n_in_block = sum(block_size)) %>%
  ungroup() %>%
  mutate(prop = n_in_block / sum(n_in_block),
         cumul_prop = scales::percent(cumsum(prop))) %>%
  select(block_size, cumul_prop) %>%
  filter(block_size %in% c(1, 2, 3, 5, 10)) %>%
  knitr::kable(col.names = c(
    'Block size',
    'Prop. in blocks $\\leq$ block size'),
    format = 'html') %>%
  kableExtra::kable_styling(full_width = F)
```

Balance

```{r, fig.width = 5, fig.height = 8}
f <- as.formula(sprintf('treat ~ %s', paste(block_var, collapse = ' + ')))
bal_check <- glm(formula = f, data = dat, family = binomial(link = 'logit'))

summary(bal_check)

z <- qnorm(0.975)

broom::tidy(bal_check) %>%
  mutate(ci_low = estimate - z * std.error,
         ci_high = estimate + z * std.error) %>%
  ggplot(aes(term, estimate)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high)) +
  coord_flip()
```

# Export

Full timestamped randomization

```{r}
ts <- format.Date(Sys.time(), format = '%Y-%m-%d_%H-%M-%S')
write_csv(dat, sprintf('full_randomization_%s.csv', ts))
```

Skinny randomization file

```{r}
dat %>%
  select(brt, treat) %>%
  write_csv(file.path('..', 'data', 'rando.csv'))
```

